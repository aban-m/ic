#!/bin/bash
set -euo pipefail

IC_DEFAULT_IMAGE="ic_base:v0.2"
IC_KEY_PATH="/home/aban/lab/ic-workspace/secrets/ic_key"

PROVISION_ARGS="${PROVISION_ARGS:-}"

NETWORK="${IC_NETWORK:-ic}"
PREFIX="${IC_PREFIX:-ic}"
IMAGE="${IC_IMAGE:-$IC_DEFAULT_IMAGE}"

create_network() {
    local NAME="$1"
    docker network inspect "$NAME" >/dev/null 2>&1 || docker network create "$NAME"
    echo "Network '$NAME' is ready."
}

provision_instance() {
    local NAME="${PREFIX}-$1"
    local NETWORK="$2"

    echo "Running container..."
    docker run -dit --name "$NAME" --hostname "$1" $PROVISION_ARGS "$IMAGE" sleep infinity

	echo "Connecting to network $NETWORK, alias $NETWORK."
    docker network connect --alias "$NETWORK" "$NETWORK" "$NAME"
    
	echo "Preparing keys..."
    docker exec "$NAME" mkdir -p /root/.ssh
    docker cp "${IC_KEY_PATH}.pub" "$NAME":/root/.ssh/authorized_keys
    docker cp "${IC_KEY_PATH}" "$NAME":/root/.ssh/id_rsa
    docker exec "$NAME" chmod 700 /root/.ssh
    docker exec "$NAME" chmod 600 /root/.ssh/authorized_keys
    docker exec "$NAME" chown -R root:root /root/.ssh

    # Start SSH daemon
    echo "Starting SSH daemon..."
    docker exec -d "$NAME" mkdir -p /run/sshd
    docker exec -d "$NAME" /usr/sbin/sshd -D
}

attach_instance() {
    local NAME="${PREFIX}-$1"
    docker start "$NAME"
    docker exec -it "$NAME" bash
}

list_instances() {
    echo -e "NAME\tSTATUS\tIP"
    for name in $(docker ps --filter "name=${PREFIX}-" --format "{{.Names}}"); do
    	ip=$(container_ip "$name")
        status=$(docker inspect -f '{{.State.Status}}' "$name")
        echo -e "$name\t$status\t$ip"
    done
}

destroy_all() {
    echo "Destroying all containers with prefix '$PREFIX'..."
    docker ps -aq --filter "name=${PREFIX}-" | xargs -r docker rm -f
    echo "All containers destroyed."
    destroy_network
}

destroy_instance() {
    local NAME="${PREFIX}-$1"
    docker rm -f "$NAME" >/dev/null 2>&1 && echo "Destroyed $NAME" || echo "$NAME not found."
}

destroy_network() {
    docker network rm "$NETWORK" >/dev/null 2>&1 && echo "Network '$NETWORK' removed" || echo "Network '$NETWORK' not found."
}

container_ip() {
	NAME="$1"
	docker inspect -f '{{.NetworkSettings.Networks.ic.IPAddress}}' "$NAME"
}

container_ssh() {
	IP=$(container_ip "${PREFIX}-$1")
	ssh -i "$IC_KEY_PATH" "root@$IP"
}

# CLI parser
[ -z "${1-}" ] && {
	list_instances
	exit 0;
}
case "$1" in
    create-network)
        create_network "$NETWORK"
        ;;
    provision)
        if [ -z "$2" ]; then
            echo "Usage: $0 provision <id>"
            exit 1
        fi
        create_network "$NETWORK"   # ensure network exists
 
        for id in "${@:2}"; do
        	echo "==== Provisioning $id... ===="
        	provision_instance "$id" "$NETWORK"
        done
        ;;
    stop)
    	docker stop "${PREFIX}-$2"
    	;;
    start)
    	docker start "${PREFIX}-$2"
    	;;
    into)
    	container_ip "${PREFIX}-$2" >> /dev/null || {
    		echo "Container not provisioned."
    		create_network "$NETWORK"
    		provision_instance "$2" "$NETWORK"
    	}
    	attach_instance "$2"
    	;;
    	
    attach)
        if [ -z "$2" ]; then
            echo "Usage: $0 attach <id>"
            exit 1
        fi
        attach_instance "$2"
        ;;
    list)
        list_instances
        ;;
    destroy)
        if [ -z "$2" ]; then
            echo "Usage: $0 destroy <id>"
            exit 1
        fi
        destroy_instance "$2"
        ;;
    destroy-network)
        destroy_network
        ;;
    destroy-all)
        destroy_all
        ;;
    ssh)
    	container_ssh "$2"
    	;;
    ip)
    	container_ip "${PREFIX}-$2"
    	;;
    *)
        echo "Usage: $0 {create-network|provision <id>|attach <id>|list|destroy <id>|destroy-network}"
        exit 1
        ;;
esac
